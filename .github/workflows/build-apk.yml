name: Let Buildozer Download Everything

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup
      run: |
        sudo apt update
        sudo apt install -y python3-pip git zip unzip openjdk-11-jdk
        pip3 install buildozer==1.4.0 cython==0.29.33 pygame==2.1.2 
    
    - name: Setup Android SDK environment
      run: |
        # Принимаем лицензии Android SDK
        yes | sudo /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # Устанавливаем необходимые компоненты
        /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager "platforms;android-30" "build-tools;30.0.3" "platform-tools"
    
    - name: Create buildozer.spec with correct paths
      run: |
          cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = org.test
        source.dir = .
        version = 1.0
        requirements = python3, pygame
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a
        android.sdk_path = /usr/local/lib/android/sdk
        android.ndk_path = /usr/local/lib/android/sdk/ndk/27.3.13750724
        android.accept_sdk_license = True

        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
    
    - name: Build APK
      run: |
        # Устанавливаем правильные пути
        export ANDROID_HOME=/usr/local/lib/android/sdk
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_NDK_HOME=/usr/local/lib/android/sdk/ndk/27.3.13750724
        export ANDROID_NDK_ROOT=/usr/local/lib/android/sdk/ndk/27.3.13750724
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        # Принудительно обновляем buildozer
        buildozer android clean
        
        # Пробуем разные варианты сборки
        echo "Вариант 1: Стандартная сборка"
        buildozer android debug 2>&1 | tail -100 || true
        
        # Если не сработало, пробуем с опцией --verbose
        echo "Вариант 2: Сборка с --verbose"
        buildozer android debug --verbose 2>&1 | tail -150 || true
    
    - name: Check for APK
      run: |
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK найден!"
          ls -la bin/*.apk
        else
          echo "❌ APK не найден"
          echo "Проверяем структуру каталогов:"
          ls -la
          if [ -d .buildozer ]; then
            echo "Содержимое .buildozer:"
            find .buildozer -type f -name "*.log" | head -5 | xargs tail -50
          fi
        fi
    
    - uses: actions/upload-artifact@v4
      if: success()
      with:
        name: apk-result
        path: bin/*.apk