name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4

    - name: Clean previous builds
      run: |
        rm -rf .buildozer ~/.buildozer bin
        
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y \
          python3 \
          python3-pip \
          python3-venv \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev
          
        pip3 install --upgrade pip wheel setuptools
        pip3 install buildozer==1.5.0 cython==0.29.33 pygame==2.1.2
        
    - name: Setup Android SDK and accept licenses
      run: |
        # Устанавливаем переменные окружения
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        # Создаем файл лицензий вручную (обход проблемы)
        mkdir -p $ANDROID_SDK_ROOT/licenses
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        echo "24333f8a63b6825ea9c5514f83c2829b004d1fee" >> $ANDROID_SDK_ROOT/licenses/android-sdk-license
        
        # Устанавливаем необходимые компоненты напрямую
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses || true
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-30"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;30.0.3"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools"
        
    - name: Create buildozer.spec
      run: |
        # Используем существующий spec файл или создаем минимальный
        if [ ! -f "buildozer.spec" ]; then
            cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3, pygame==2.1.2
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a

        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
        else
          echo "Используем существующий buildozer.spec"
          cat buildozer.spec
        fi
        
    - name: Pre-download python-for-android (ИСПРАВЛЕНО)
      run: |
        mkdir -p .buildozer/android/platform
        cd .buildozer/android/platform
        
        # Удаляем старую версию если есть
        rm -rf python-for-android
        
        echo "=== Клонируем python-for-android ==="
        
        # ВАРИАНТ 1: Используем master ветку (самый простой и надежный)
        git clone --depth 1 https://github.com/kivy/python-for-android.git
        
        # ИЛИ ВАРИАНТ 2: Используем конкретный тег (нужно клонировать сначала, потом переключиться)
        # git clone https://github.com/kivy/python-for-android.git
        # cd python-for-android
        # git fetch --tags
        # git checkout 2024.01.21  # или другой тег
        
        echo "✓ python-for-android успешно скачан"
        
    - name: Build APK
      env:
        ANDROID_HOME: /usr/local/lib/android/sdk
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.3.13750724
        ANDROID_NDK_ROOT: /usr/local/lib/android/sdk/ndk/27.3.13750724
        JAVA_HOME: /usr/lib/jvm/temurin-11-jdk-amd64
      run: |
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        echo "=== Проверяем наличие main.py ==="
        if [ -f "main.py" ]; then
          echo "✓ main.py найден ($(wc -l < main.py) строк)"
          echo "Первые 3 строки:"
          head -3 main.py
        else
          echo "✗ ОШИБКА: main.py не найден!"
          exit 1
        fi
        
        echo "=== Проверяем зависимости ==="
        if [ -f "requirements.txt" ]; then
          echo "requirements.txt:"
          cat requirements.txt
        fi
        
        echo "=== Запускаем сборку Wave Defender ==="
        
        # Инициализируем если нужно
        buildozer init 2>&1 | tail -10 || true
        
        # Используем системный NDK
        export P4A_NDK_VERSION=27
        
        # Запускаем сборку с подробным логом
        echo "Сборка началась (это может занять 20-30 минут)..."
        timeout 2700 buildozer -v android debug 2>&1 | tee build.log
        
        # Проверяем результат
        if [ -f bin/*.apk ]; then
          echo "✓ Сборка завершена успешно!"
        else
          echo "⚠ Сборка не удалась, проверяем логи..."
          tail -200 build.log | grep -A10 -B10 "error\|Error\|ERROR\|fail\|Fail\|FAIL"
        fi
        
    - name: Check and upload APK
      run: |
        echo "=== Проверка результата ==="
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ SUCCESS: APK найден!"
          APK_FILE=$(ls bin/*.apk)
          echo "Файл: $APK_FILE"
          echo "Размер: $(du -h "$APK_FILE" | cut -f1)"
          echo "Дата: $(date -r "$APK_FILE")"
        else
          echo "❌ FAILED: APK не найден"
          echo "Ищем логи ошибок..."
          
          # Проверяем наличие логов
          if [ -f "build.log" ]; then
            echo "Последние ошибки из build.log:"
            tail -100 build.log | grep -i "error\|fail\|exception"
          fi
          
          if [ -d ".buildozer" ]; then
            echo "Логи buildozer:"
            find .buildozer -name "*.log" -type f | head -3 | while read log; do
              echo "=== $log ==="
              tail -50 "$log" 2>/dev/null || true
            done
          fi
        fi
        
    - uses: actions/upload-artifact@v4
      if: success()
      with:
        name: apk-result
        path: bin/*.apk