name: Build Android APK Complete

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v4

    - name: Create configuration files
      run: |
        # Создаем main.py если его нет
        if [ ! -f main.py ]; then
          cat > main.py << 'EOF'
        from kivy.app import App
        from kivy.uix.label import Label

        class MyApp(App):
            def build(self):
                return Label(text="Built on GitHub Actions")

        if __name__ == "__main__":
            MyApp().run()
        EOF
                fi
        
        # Создаем правильный buildozer.spec
        cat > buildozer.spec << 'EOF'
        [app]
        title = MyApp
        package.name = myapp
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3,kivy
        orientation = portrait
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a

        [buildozer]
        log_level = 2
        warn_on_root = 0

        # Указываем использовать локальную директорию для .buildozer
        build_dir = ./.buildozer
        bin_dir = ./bin
        EOF

    - name: Build APK with Docker (fixed permissions)
      run: |
        # Создаем директории с правильными правами
        mkdir -p .buildozer bin
        chmod 777 .buildozer bin
        
        # Создаем скрипт для запуска внутри контейнера
        cat > docker_build.sh << 'SCRIPT'
        #!/bin/bash
        # Внутри контейнера

        # Устанавливаем правильные переменные окружения
        export HOME=/tmp/home
        mkdir -p $HOME

        # Создаем конфиг для buildozer
        mkdir -p $HOME/.buildozer
        cat > $HOME/.buildozer/config << 'CONFIG'
        [buildozer]
        warn_on_root = 0
        log_level = 2
        CONFIG

        # Запускаем сборку
        cd /app
        buildozer android debug
        SCRIPT
                
                chmod +x docker_build.sh
        
        # Запускаем Docker
        docker run --rm \
          -v ${{ github.workspace }}:/app:rw \
          -v /tmp/buildozer_home:/tmp/home:rw \
          kivy/buildozer \
          /bin/bash -c "/app/docker_build.sh"

    - name: Check and upload APK
      run: |
        echo "Проверяем результаты сборки..."
        if ls bin/*.apk 1>/dev/null 2>&1; then
          echo "✅ APK создан успешно!"
          ls -lh bin/*.apk
          echo "Размер APK: $(du -h bin/*.apk | cut -f1)"
        else
          echo "⚠️  APK не найден в bin/"
          echo "Ищем во всех директориях..."
          find . -name "*.apk" 2>/dev/null || echo "APK не найдены"
          exit 0  # Не завершаем с ошибкой, просто предупреждаем
        fi

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: android-app
        path: |
          bin/*.apk
          *.apk
        if-no-files-found: warn