name: Build Wave Defender with PyGame

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Python and dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-dev python3-venv
        
        # Создаем виртуальное окружение
        python3 -m venv venv
        source venv/bin/activate
        
        # Устанавливаем ВСЕ зависимости
        pip install --upgrade pip setuptools wheel
        pip install cython==0.29.36  # Обязательно!
        pip install buildozer
        pip install pygame==2.5.0
        
        echo "✅ Зависимости установлены"
        
    - name: Configure buildozer.spec
      run: |
        source venv/bin/activate
        
        # Используем ваш существующий spec или создаем новый
        if [ ! -f buildozer.spec ]; then
          echo "Создаю buildozer.spec..."
          cat > buildozer.spec << 'EOF'
          [app]
          title = Wave Defender
          package.name = wavedefender
          package.domain = com.astafevdanil9
          source.dir = .
          source.main = main.py
          version = 1.0
          requirements = python3,pygame
          orientation = landscape
          fullscreen = 1
          android.archs = armeabi-v7a
          android.permissions = INTERNET, VIBRATE
          android.api = 30
          android.minapi = 21

          [buildozer]
          warn_on_root = 0
          log_level = 2
          android.accept_sdk_license = True
          EOF
        else
          echo "Использую существующий buildozer.spec"
        fi
        
        echo "=== Проверка конфига ==="
        grep -E "^(version|requirements)" buildozer.spec
    
    - name: Build APK
      run: |
        source venv/bin/activate
        
        # Увеличиваем swap
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "=== Запуск buildozer ==="
        buildozer android debug
        
        sudo swapoff /swapfile
        sudo rm /swapfile
        
        # Проверка
        if [ -f bin/*.apk ]; then
          echo "✅ Готово!"
        else
          echo "❌ Ошибка"
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: wave-defender-game
        path: bin/*.apk