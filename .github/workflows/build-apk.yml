name: Build PyGame Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install all dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-dev git
        sudo apt install -y libsdl2-dev libsdl2-ttf-dev
        sudo apt install -y libssl-dev libffi-dev zlib1g-dev
        
        pip3 install pygame buildozer cython
        
    - name: Create buildozer.spec
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = com.astafevdanil9
        source.dir = .
        source.main = main.py
        version = 1.0
        requirements = python3,pygame
        orientation = landscape
        fullscreen = 1
        android.archs = armeabi-v7a
        android.permissions = INTERNET, VIBRATE
        android.api = 30
        android.minapi = 21
        android.ndk = 21.4.7075529

        [buildozer]
        warn_on_root = 0
        log_level = 2
        android.accept_sdk_license = True
        EOF
    
    - name: Accept licenses
      run: |
        mkdir -p ~/.android/licenses
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/licenses/android-sdk-license
        
    - name: Build
      run: |
        sudo fallocate -l 2G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        buildozer android debug
        
        sudo swapoff /swapfile
        sudo rm /swapfile
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk-file
        path: bin/*.apk