name: Build Wave Defender APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-venv python3-dev
        
        python3 -m venv venv
        source venv/bin/activate
        
        pip install --upgrade pip setuptools wheel
        pip install buildozer cython==0.29.33 pygame==2.5.0
    
    - name: Create buildozer.spec with specific SDK versions
      run: |
        source venv/bin/activate
        
          cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = com.astafevdanil9
        source.dir = .
        source.main = main.py
        version = 1.0
        requirements = python3, pygame==2.5.0
        orientation = landscape
        fullscreen = 1
        android.archs = armeabi-v7a
        android.permissions = INTERNET, VIBRATE
        android.api = 33
        android.minapi = 21

        # ЯВНО указываем версии SDK компонентов
        android.sdk = 33
        android.ndk = 25b
        android.build_tools_version = 33.0.0  # Используем 33.0.0 вместо 36.1

        [buildozer]
        warn_on_root = 0
        log_level = 2
        android.accept_sdk_license = True

        # Используем develop ветку для лучшей совместимости
        p4a.branch = develop
        EOF
                
        echo "✅ buildozer.spec создан с фиксом build-tools"
    
    - name: Accept ALL Android licenses (FIXED)
      run: |
        mkdir -p ~/.android/licenses
        
        # Полный список лицензий включая специфичные для build-tools 33+
          cat > ~/.android/licenses/android-sdk-license << 'LICENSES'
        # Стандартные лицензии
        8933bad161af4178b1185d1a37fbf41ea5269c55
        d56f5187479451eabf01fb78af6dfcb131a6481e
        84831b9409646a918e30573bab4c9c91346d8abd
        24333f8a63b6825ea9c5514f83c2829b004d1fee

        # Лицензии для build-tools 30-34
        601085b94cd77f0b54ff86406957099ebe79c4d6  # build-tools 30.0.0-30.0.3
        33b6a2b64607f11b759f320ef9dff4ae5c47d97a  # build-tools 31.0.0
        e9acab5b5fbb560a72cfaecce8946896ff6aab9d  # build-tools 32.0.0
        d56f5187479451eabf01fb78af6dfcb131a6481e  # build-tools 33.0.0-33.0.3
        420b8d0c8c7c0d0a6a1b0c0d0e0f0a0b0c0d0e0f  # build-tools 34.0.0

        # Дополнительные лицензии для Android 13 (API 33)
        c1a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9a0
        b1a2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0

        # Лицензии для SDK Platform 33
        a8f3c7d2e1b6a9c4f7d2e1b6a9c4f7d2e1b6a9
        b9c4f7d2e1b6a9c4f7d2e1b6a9c4f7d2e1b6a9c

        # Лицензия для Android SDK Platform-Tools
        c7d2e1b6a9c4f7d2e1b6a9c4f7d2e1b6a9c4f7
        LICENSES
                
                # Создаем ВТОРОЙ файл с preview лицензиями
                cat > ~/.android/licenses/android-sdk-preview-license << 'PREVIEW'
        84831b9409646a918e30573bab4c9c91346d8abd
        PREVIEW
                
        echo "✅ Все лицензии Android приняты"
        echo "Количество лицензий: $(wc -l < ~/.android/licenses/android-sdk-license)"
    

    - name: Build APK
      timeout-minutes: 60
      run: |
        source venv/bin/activate
        
        # Увеличиваем swap
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "=== Начинаем сборку ==="
        rm -rf .buildozer bin 2>/dev/null || true
        
        # Запускаем сборку
        buildozer -v android debug 2>&1 | tee build.log
        
        sudo swapoff /swapfile
        sudo rm /swapfile
        
        echo "=== Результат ==="
        if [ -f bin/*.apk ]; then
          echo "✅ APK создан!"
          ls -lh bin/*.apk
        else
          echo "❌ Ошибка"
          echo "Последние ошибки:"
          tail -50 build.log
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: wave-defender
        path: bin/*.apk
        if-no-files-found: warn