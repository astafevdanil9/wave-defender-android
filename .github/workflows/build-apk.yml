name: Build PyGame Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup for PyGame
      run: |
        sudo apt update
        # Минимальный набор для pygame
        sudo apt install -y \
          python3-pip \
          python3-dev \
          git \
          libsdl2-dev \
          libsdl2-ttf-dev \
          libsdl2-image-dev \
          libsdl2-mixer-dev
        
        # Устанавливаем pygame с source
        pip3 install pygame==2.5.0 --no-binary pygame
        
        # Buildozer и зависимости
        pip3 install buildozer cython
        
    - name: Update buildozer.spec
      run: |
        # Добавляем настройки для Android
        echo "" >> buildozer.spec
        echo "# Android settings" >> buildozer.spec
        echo "android.api = 33" >> buildozer.spec
        echo "android.minapi = 21" >> buildozer.spec
        
    - name: Build
      run: |
        # Создаем swap
        sudo fallocate -l 2G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        # Собираем
        buildozer android debug
        
        # Очищаем swap
        sudo swapoff /swapfile
        sudo rm /swapfile
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: game-apk
        path: bin/*.apk