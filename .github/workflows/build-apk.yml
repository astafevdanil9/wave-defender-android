name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4

    - name: Clean previous builds
      run: |
        rm -rf .buildozer ~/.buildozer bin
        
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y \
          python3 \
          python3-pip \
          python3-venv \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          wget
          
        pip3 install --upgrade pip wheel setuptools
        pip3 install buildozer==1.5.0 cython==0.29.33 pygame==2.1.2
        
    - name: Setup Android SDK and ACCEPT LICENSES (КРИТИЧЕСКИ ВАЖНО)
      run: |
        # Устанавливаем переменные окружения
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        echo "=== ПРИНИМАЕМ ЛИЦЕНЗИИ ANDROID SDK ==="
        
        # СПОСОБ 1: Создаем файлы лицензий вручную (гарантировано работает)
        mkdir -p $ANDROID_SDK_ROOT/licenses
          cat > $ANDROID_SDK_ROOT/licenses/android-sdk-license << 'EOF'
        8933bad161af4178b1185d1a37fbf41ea5269c55
        d56f5187479451eabf01fb78af6dfcb131a6481e
        24333f8a63b6825ea9c5514f83c2829b004d1fee
        84831b9409646a918e30573b4ad6cb1653d37abb
        33b6a2b64607f11b759f320ef9dff4ae5c47d97a
        79120722343a6f314e0719f863036c702b0e6b2a
        e9acab5b5fbb560a72cfaecce8946896ff6aab9d
        85b5a0da6d1e23e8f42d5a1e0c75470e6493b7c7
        EOF
        
        echo "✓ Созданы файлы лицензий"
        ls -la $ANDROID_SDK_ROOT/licenses/
        
        # СПОСОБ 2: Пробуем принять через sdkmanager (дополнительная проверка)
        echo "=== Пробуем принять лицензии через sdkmanager ==="
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses 2>&1 | tail -20 || echo "Продолжаем сборку..."
        
        # Устанавливаем необходимые компоненты
        echo "=== Устанавливаем Android компоненты ==="
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-30"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;30.0.3"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "tools"
        
        echo "✓ Android SDK настроен"
        
    - name: Create buildozer.spec with license acceptance
      run: |
        # Создаем spec с явным указанием принятия лицензий
          cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas,wav,ogg,ttf
        version = 1.0
        requirements = python3, pygame==2.1.2
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a
        # Указываем что лицензии уже приняты
        android.accept_sdk_license = true
        android.sdk_path = /usr/local/lib/android/sdk
        android.ndk_path = /usr/local/lib/android/sdk/ndk/27.3.13750724

        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF
        
        echo "✓ buildozer.spec создан"
        echo "Содержимое buildozer.spec:"
        cat buildozer.spec
        
    - name: Pre-download python-for-android
      run: |
        mkdir -p .buildozer/android/platform
        cd .buildozer/android/platform
        
        # Удаляем старую версию если есть
        rm -rf python-for-android
        
        echo "=== Клонируем python-for-android ==="
        git clone --depth 1 https://github.com/kivy/python-for-android.git
        
        echo "✓ python-for-android успешно скачан"
        
    - name: Verify setup before build
      run: |
        echo "=== ПРОВЕРКА ПЕРЕД СБОРКОЙ ==="
        echo "1. Проверяем лицензии:"
        ls -la /usr/local/lib/android/sdk/licenses/ 2>/dev/null || echo "Директория лицензий не найдена"
        
        echo "2. Проверяем Android SDK:"
        ls -la /usr/local/lib/android/sdk/platforms/ 2>/dev/null || echo "Директория platforms не найдена"
        
        echo "3. Проверяем build-tools:"
        ls -la /usr/local/lib/android/sdk/build-tools/ 2>/dev/null || echo "Директория build-tools не найдена"
        
        echo "4. Проверяем main.py:"
        if [ -f "main.py" ]; then
          echo "✓ main.py существует ($(wc -l < main.py) строк)"
        else
          echo "✗ ОШИБКА: main.py не найден!"
          exit 1
        fi
        
    - name: Build APK
      env:
        ANDROID_HOME: /usr/local/lib/android/sdk
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.3.13750724
        ANDROID_NDK_ROOT: /usr/local/lib/android/sdk/ndk/27.3.13750724
        JAVA_HOME: /usr/lib/jvm/temurin-11-jdk-amd64
      run: |
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        echo "=== НАЧИНАЕМ СБОРКУ WAVE DEFENDER ==="
        
        # Очищаем предыдущие сборки
        buildozer android clean 2>&1 | tail -10 || true
        
        # Используем системный NDK
        export P4A_NDK_VERSION=27
        
        echo "Сборка началась... (это может занять 20-40 минут)"
        echo "Время начала: $(date)"
        
        # Запускаем сборку с подробным логом
        timeout 3600 buildozer -v android debug 2>&1 | tee build.log
        
        echo "Время окончания: $(date)"
        
        # Проверяем результат
        if [ -f bin/*.apk ]; then
          echo "✅ СБОРКА УСПЕШНО ЗАВЕРШЕНА!"
        else
          echo "⚠ Сборка завершилась, но APK не найден"
          echo "Ищем ошибки в логах..."
        fi
        
    - name: Check and upload APK
      run: |
        echo "=== ФИНАЛЬНАЯ ПРОВЕРКА ==="
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "✅ УСПЕХ: APK создан!"
          echo "Файл: $APK_FILE"
          echo "Размер: $(du -h "$APK_FILE" | cut -f1)"
          echo "Версия: $(date -r "$APK_FILE")"
          
          # Показываем информацию о APK
          echo "Информация о APK:"
          /usr/local/lib/android/sdk/build-tools/30.0.3/aapt dump badging "$APK_FILE" 2>/dev/null | grep -E "package|launchable" || true
        else
          echo "❌ ОШИБКА: APK не создан"
          echo "=== АНАЛИЗ ОШИБОК ==="
          
          if [ -f "build.log" ]; then
            echo "Последние ошибки из лога:"
            grep -i -A5 -B5 "error\|fail\|exception\|traceback" build.log | tail -100 || echo "Явных ошибок не найдено"
            
            echo "Последние 50 строк лога:"
            tail -50 build.log
          fi
          
          # Проверяем наличие лицензий (частая проблема)
          echo "Проверка лицензий Android SDK:"
          if [ -d "/usr/local/lib/android/sdk/licenses" ]; then
            echo "Файлы лицензий:"
            cat /usr/local/lib/android/sdk/licenses/* 2>/dev/null || echo "Не удалось прочитать лицензии"
          else
            echo "Директория лицензий не существует!"
          fi
          
          exit 1
        fi
        
    - uses: actions/upload-artifact@v4
      if: success()
      with:
        name: wave-defender-apk
        path: bin/*.apk