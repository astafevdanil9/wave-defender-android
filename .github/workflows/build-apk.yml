name: Build Wave Defender with PyGame

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install Python and dependencies
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-dev python3-venv
        
        # Создаем виртуальное окружение
        python3 -m venv venv
        source venv/bin/activate
        
        # Устанавливаем ВСЕ зависимости
        pip install --upgrade pip setuptools wheel
        pip install cython==0.29.36  # Обязательно!
        pip install buildozer
        pip install pygame==2.5.0
        
        echo "✅ Зависимости установлены"
        
    - name: Configure buildozer.spec
      run: |
        source venv/bin/activate
        
        # Используем ваш существующий spec или создаем новый
        if [ ! -f buildozer.spec ]; then
          echo "Создаю buildozer.spec..."
          cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = com.astafevdanil9
        source.dir = .
        source.main = main.py
        version = 1.0
        requirements = python3,pygame
        orientation = landscape
        fullscreen = 1
        android.archs = armeabi-v7a
        android.permissions = INTERNET, VIBRATE
        android.api = 30
        android.minapi = 21

        [buildozer]
        warn_on_root = 0
        log_level = 2
        android.accept_sdk_license = True
        EOF
        else
          echo "Использую существующий buildozer.spec"
          
          # Исправляем существующий файл если нужно
          python3 << 'PY'
          import configparser
          import os

          if os.path.exists('buildozer.spec'):
              config = configparser.ConfigParser()
              config.read('buildozer.spec')
              
            # Убеждаемся что есть обязательные поля
            if 'app' not in config:
                config['app'] = {}
            
            # Добавляем version если нет
            if 'version' not in config['app']:
                config['app']['version'] = '1.0'
            
            # Добавляем buildozer секцию если нет
            if 'buildozer' not in config:
                config['buildozer'] = {}
            
            config['buildozer']['warn_on_root'] = '0'
            config['buildozer']['android.accept_sdk_license'] = 'True'
            
            with open('buildozer.spec', 'w') as f:
                config.write(f)
            
            print("✅ buildozer.spec обновлен")
        PY
                fi
                
        echo "=== Проверка конфига ==="
        cat buildozer.spec
    
    - name: Accept Android licenses
      run: |
        # Принимаем лицензии Android SDK
        mkdir -p ~/.android/licenses
        echo "8933bad161af4178b1185d1a37fbf41ea5269c55" > ~/.android/licenses/android-sdk-license
        echo "d56f5187479451eabf01fb78af6dfcb131a6481e" >> ~/.android/licenses/android-sdk-license
        
    - name: Build APK
      timeout-minutes: 60
      run: |
        source venv/bin/activate
        
        # Увеличиваем swap
        sudo fallocate -l 4G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        echo "=== Запуск buildozer ==="
        
        # Очищаем предыдущие сборки
        rm -rf .buildozer bin 2>/dev/null || true
        
        # Запускаем сборку с логом
        buildozer -v android debug 2>&1 | tee build.log
        
        sudo swapoff /swapfile
        sudo rm /swapfile
        
        # Проверка
        echo "=== Результат сборки ==="
        if [ -f bin/*.apk ]; then
          echo "✅ УСПЕХ: APK создан!"
          ls -lh bin/*.apk
        else
          echo "❌ Ошибка: APK не создан"
          echo "Последние ошибки из лога:"
          tail -100 build.log | grep -i "error\|fail\|warn" || echo "Явных ошибок не найдено"
        fi
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: wave-defender-game
        path: bin/*.apk
        if-no-files-found: warn
    
    - name: Upload log if failed
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: build-logs
        path: build.log