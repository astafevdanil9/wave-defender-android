name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4

    - name: Clean previous builds
      run: |
        rm -rf .buildozer ~/.buildozer bin
        
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y \
          python3 \
          python3-pip \
          python3-venv \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev \
          wget
          
        pip3 install --upgrade pip wheel setuptools
        pip3 install buildozer cython pygame==2.1.2
        
    - name: Setup Android SDK with modern tools (КРИТИЧЕСКИ ВАЖНО)
      run: |
        # Устанавливаем переменные окружения
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        
        # УДАЛЯЕМ старые tools которые вызывают ошибку
        echo "=== УДАЛЯЕМ старые инструменты tools/ ==="
        rm -rf $ANDROID_SDK_ROOT/tools 2>/dev/null || true
        
        # Используем ТОЛЬКО современные cmdline-tools
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        echo "=== Принимаем лицензии ==="
        # Создаем файлы лицензий вручную (гарантированно работает)
        mkdir -p $ANDROID_SDK_ROOT/licenses
          cat > $ANDROID_SDK_ROOT/licenses/android-sdk-license << 'EOF'
        8933bad161af4178b1185d1a37fbf41ea5269c55
        d56f5187479451eabf01fb78af6dfcb131a6481e
        24333f8a63b6825ea9c5514f83c2829b004d1fee
        84831b9409646a918e30573b4ad6cb1653d37abb
        33b6a2b64607f11b759f320ef9dff4ae5c47d97a
        79120722343a6f314e0719f863036c702b0e6b2a
        e9acab5b5fbb560a72cfaecce8946896ff6aab9d
        85b5a0da6d1e23e8f42d5a1e0c75470e6493b7c7
        EOF
        
        # Принимаем лицензии через современные инструменты
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses 2>&1 | tail -10 || true
        
        echo "=== Устанавливаем компоненты через cmdline-tools ==="
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platforms;android-30"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "build-tools;30.0.3"
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager "platform-tools"
        
        echo "✓ Android SDK настроен с использованием cmdline-tools"
        
    - name: Create buildozer.spec that forces cmdline-tools
      run: |
        # Создаем spec с ЯВНЫМ отключением старого sdkmanager
          cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas,wav,ogg,ttf
        version = 1.0
        requirements = python3, pygame==2.1.2
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a
        # КРИТИЧЕСКИ ВАЖНО: отключаем авто-обновление SDK
        android.skip_update = true
        android.sdk_path = /usr/local/lib/android/sdk
        android.ndk_path = /usr/local/lib/android/sdk/ndk/27.3.13750724

        [buildozer]
        log_level = 2
        warn_on_root = 0

        # ПЕРЕОПРЕДЕЛЯЕМ команды sdkmanager
        [app:source]
        android.sdkmanager_cmd = /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager
        EOF
        
        echo "✓ buildozer.spec создан с переопределением sdkmanager"
        
    - name: Patch Buildozer to use correct sdkmanager
      run: |
        # Патчим buildozer чтобы он использовал правильный путь
        echo "=== Патчим buildozer ==="
        
        # Находим файл android.py в buildozer
        BUILDOCER_ANDROID_PY=$(python3 -c "import buildozer.targets.android as a; print(a.__file__)" 2>/dev/null || echo "")
        
        if [ -f "$BUILDOCER_ANDROID_PY" ]; then
          echo "Найден файл buildozer android: $BUILDOCER_ANDROID_PY"
          # Делаем backup
          cp "$BUILDOCER_ANDROID_PY" "${BUILDOCER_ANDROID_PY}.backup"
        fi
        
        # Альтернативно создаем wrapper скрипт
          cat > /tmp/use_cmdline_sdkmanager.sh << 'EOF'
        #!/bin/bash
        # Форсируем использование cmdline-tools вместо старых tools
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export PATH=/usr/local/lib/android/sdk/cmdline-tools/latest/bin:$PATH
        exec /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager "$@"
        EOF
        
        chmod +x /tmp/use_cmdline_sdkmanager.sh
        
    - name: Setup python-for-android
      run: |
        mkdir -p .buildozer/android/platform
        cd .buildozer/android/platform
        
        # Удаляем старую версию если есть
        rm -rf python-for-android
        
        echo "=== Клонируем python-for-android ==="
        git clone --depth 1 https://github.com/kivy/python-for-android.git
        
        echo "✓ python-for-android успешно скачан"
        
    - name: Build APK with patched environment
      env:
        # Явно задаем пути к СОВРЕМЕННЫМ инструментам
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        ANDROID_HOME: /usr/local/lib/android/sdk
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.3.13750724
        JAVA_HOME: /usr/lib/jvm/temurin-11-jdk-amd64
        # Отключаем авто-обновление SDK внутри buildozer
        BUILDOCER_SKIP_SDK_UPDATE: 1
      run: |
        # Форсируем использование cmdline-tools
        export PATH=/usr/local/lib/android/sdk/cmdline-tools/latest/bin:$PATH
        
        # Удаляем старый tools если он снова появился
        rm -rf /usr/local/lib/android/sdk/tools 2>/dev/null || true
        
        echo "=== ПРОВЕРКА ИНСТРУМЕНТОВ ==="
        echo "Проверяем sdkmanager:"
        which sdkmanager
        sdkmanager --version 2>&1 | head -5 || echo "Не удалось получить версию"
        
        echo "Проверяем Java:"
        java -version
        
        echo "=== НАЧИНАЕМ СБОРКУ ==="
        
        # Создаем симлинк чтобы buildozer находил cmdline-tools как tools
        mkdir -p /tmp/android-sdk-tools
        ln -sf /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager /tmp/android-sdk-tools/sdkmanager 2>/dev/null || true
        
        # Запускаем сборку с минимальной проверкой SDK
        echo "Запускаем buildozer..."
        
        # Используем прямое выполнение с переопределением
        python3 -m buildozer android debug \
          --skip-check-sdk \
          --skip-check-android-sdk \
          2>&1 | tee build.log
        
        echo "Сборка завершена в $(date)"
        
    - name: Check result and upload
      run: |
        echo "=== ПРОВЕРКА РЕЗУЛЬТАТА ==="
        
        if ls bin/*.apk 1> /dev/null 2>&1; then
          APK_FILE=$(ls bin/*.apk | head -1)
          echo "✅ УСПЕХ: APK создан!"
          echo "Файл: $APK_FILE"
          echo "Размер: $(du -h "$APK_FILE" | cut -f1)"
          
          # Выводим базовую информацию о APK
          if [ -f "/usr/local/lib/android/sdk/build-tools/30.0.3/aapt" ]; then
            echo "Информация о пакете:"
            /usr/local/lib/android/sdk/build-tools/30.0.3/aapt dump badging "$APK_FILE" 2>/dev/null | \
              grep -E "package:|launchable-activity:|application:" | head -3 || true
          fi
        else
          echo "❌ ОШИБКА: APK не создан"
          echo "=== АНАЛИЗ ЛОГА ==="
          
          if [ -f "build.log" ]; then
            echo "Последние ошибки:"
            grep -i -B5 -A5 "error\|exception\|fail\|traceback" build.log | tail -50 || echo "Явных ошибок не найдено"
            
            echo "=== КРИТИЧЕСКАЯ ПРОВЕРКА ==="
            echo "1. Проверяем путь к sdkmanager:"
            ls -la /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager 2>/dev/null || echo "sdkmanager не найден!"
            
            echo "2. Проверяем старый tools:"
            if [ -d "/usr/local/lib/android/sdk/tools" ]; then
              echo "⚠ ВНИМАНИЕ: старый tools/ все еще существует!"
              rm -rf /usr/local/lib/android/sdk/tools
            fi
          fi
          
          exit 1
        fi
        
    - uses: actions/upload-artifact@v4
      if: success()
      with:
        name: wave-defender-apk
        path: bin/*.apk