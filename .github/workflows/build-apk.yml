name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # 1. Забираем код
      - uses: actions/checkout@v4

      # 2. Подготовка main.py
      - name: Create main.py
        run: |
          cat > main.py << 'EOF'
          from kivy.app import App
          from kivy.uix.label import Label

          class TestApp(App):
              def build(self):
                  return Label(text="Hello from CI Build!")

          if __name__ == '__main__':
              TestApp().run()
          EOF

      # 3. Подготовка buildozer.spec
      - name: Create buildozer.spec
        run: |
          cat > buildozer.spec << 'EOF'
          [app]
          title = TestApp
          package.name = testapp
          package.domain = org.example
          source.dir = .
          source.include_exts = py,png,jpg,kv,atlas
          version = 1.0
          requirements = python3,kivy
          orientation = portrait
          android.api = 33
          android.minapi = 21
          android.archs = armeabi-v7a

          [buildozer]
          log_level = 2
          android.accept_sdk_license = True
          EOF

      # 4. Сборка APK через Docker Buildozer
      - name: Build APK (Docker)
        uses: docker://pybee/buildozer:latest
        with:
          options: >
            --rm
            -v ${{ github.workspace }}:/app
        run: |
          cd /app
          buildozer android debug

      # 5. Загрузка APK
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: android-apk
          path: bin/*.apk
          if-no-files-found: warn
