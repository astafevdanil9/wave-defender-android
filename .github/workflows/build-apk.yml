name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    # 1. Забираем код
    - uses: actions/checkout@v4

    # 2. Установка Python 3.9
    - name: Setup Python 3.9
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    # 3. Установка Java 17
    - name: Setup Java 17
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    # 4. УДАЛЯЕМ СТАРЫЙ SDK И СКАЧИВАЕМ ПОЛНЫЙ ANDROID COMMAND LINE TOOLS
    - name: Download complete Android Command Line Tools
      run: |
        echo "=== Скачивание ПОЛНОГО Android Command Line Tools ==="
        
        # Удаляем всё
        sudo rm -rf /usr/local/lib/android 2>/dev/null || true
        sudo mkdir -p /usr/local/lib/android/sdk
        
        # СКАЧИВАЕМ ПОЛНУЮ ВЕРСИЮ COMMAND LINE TOOLS
        cd /usr/local/lib/android/sdk
        echo "Скачивание Command Line Tools..."
        sudo wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        
        echo "Распаковка..."
        sudo unzip -q commandlinetools-linux-9477386_latest.zip
        
        # КРИТИЧЕСКИ ВАЖНО: правильная структура после распаковки
        echo "Создание правильной структуры..."
        
        # После распаковки у нас должна быть директория 'cmdline-tools' с содержимым
        if [ -d "cmdline-tools" ]; then
          echo "✅ Структура cmdline-tools найдена"
          # Перемещаем в latest
          sudo mv cmdline-tools latest
        elif [ -d "tools" ]; then
          echo "Структура tools найдена, переименовываем..."
          sudo mkdir -p cmdline-tools
          sudo mv tools cmdline-tools/latest
        else
          echo "⚠️ Неожиданная структура. Содержимое:"
          ls -la
          # Создаем структуру вручную
          sudo mkdir -p cmdline-tools/latest
          sudo mv * cmdline-tools/latest/ 2>/dev/null || true
        fi
        
        # ПРОВЕРЯЕМ НАЛИЧИЕ КЛЮЧЕВЫХ ФАЙЛОВ
        echo "Проверка ключевых файлов..."
        
        # sdkmanager должен быть здесь
        SDKMANAGER_PATH="/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager"
        if [ ! -f "$SDKMANAGER_PATH" ]; then
          echo "❌ sdkmanager не найден! Ищем..."
          find /usr/local/lib/android/sdk -name "sdkmanager" -type f
          
          # Пытаемся найти и скопировать
          FOUND_SDKMANAGER=$(find /usr/local/lib/android/sdk -name "sdkmanager" -type f | head -1)
          if [ -n "$FOUND_SDKMANAGER" ]; then
            echo "Найден sdkmanager: $FOUND_SDKMANAGER"
            sudo mkdir -p /usr/local/lib/android/sdk/cmdline-tools/latest/bin
            sudo cp "$FOUND_SDKMANAGER" "$SDKMANAGER_PATH"
            sudo chmod +x "$SDKMANAGER_PATH"
          else
            echo "Создаем минимальный sdkmanager скрипт..."
            sudo tee "$SDKMANAGER_PATH" << 'EOF'
          #!/bin/bash
          echo "ERROR: sdkmanager is not properly installed"
          echo "Please check Android Command Line Tools installation"
          exit 1
          EOF
            sudo chmod +x "$SDKMANAGER_PATH"
          fi
        fi
        
        # Проверяем наличие JAR файлов
        echo "Проверка JAR файлов в lib/..."
        if [ -d "/usr/local/lib/android/sdk/cmdline-tools/latest/lib" ]; then
          echo "Содержимое lib/:"
          ls -la /usr/local/lib/android/sdk/cmdline-tools/latest/lib/*.jar 2>/dev/null || echo "Нет JAR файлов"
          
          # Если нет ключевых JAR, скачиваем отдельно
          if [ ! -f "/usr/local/lib/android/sdk/cmdline-tools/latest/lib/sdkmanager-classpath.jar" ]; then
            echo "⚠️ Ключевые JAR файлы отсутствуют"
            echo "Скачиваем необходимые библиотеки..."
            cd /tmp
            wget -q https://github.com/google/android-sdk-tools/raw/main/sdkmanager-classpath.jar -O /tmp/sdkmanager-classpath.jar 2>/dev/null || echo "Не удалось скачать"
          fi
        fi
        
        echo "✅ Android Command Line Tools установлены"

    # 5. СОЗДАЕМ ПОЛНУЮ СТРУКТУРУ ДЛЯ BUILDOZER
    - name: Create complete structure for Buildozer
      run: |
        echo "=== Создание полной структуры для Buildozer ==="
        
        SDK_BASE="/usr/local/lib/android/sdk"
        
        # 1. СОЗДАЕМ tools/bin И СИМВОЛИЧЕСКИЕ ССЫЛКИ
        echo "Создаем tools/bin структуру..."
        sudo mkdir -p "$SDK_BASE/tools/bin"
        
        # Создаем символическую ссылку на sdkmanager
        SDKMANAGER_SOURCE="$SDK_BASE/cmdline-tools/latest/bin/sdkmanager"
        SDKMANAGER_TARGET="$SDK_BASE/tools/bin/sdkmanager"
        
        if [ -f "$SDKMANAGER_SOURCE" ]; then
          echo "Создаем ссылку: $SDKMANAGER_TARGET -> $SDKMANAGER_SOURCE"
          sudo ln -sf "$SDKMANAGER_SOURCE" "$SDKMANAGER_TARGET"
          echo "✅ Ссылка на sdkmanager создана"
        else
          echo "❌ sdkmanager не найден для создания ссылки"
          # Создаем заглушку
          sudo tee "$SDKMANAGER_TARGET" << 'EOF'
        #!/bin/bash
        # Заглушка для Buildozer
        echo "Using direct sdkmanager path"
        exec /usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager "$@"
        EOF
          sudo chmod +x "$SDKMANAGER_TARGET"
        fi
        
        # 2. СОЗДАЕМ ССЫЛКИ НА ДРУГИЕ ИНСТРУМЕНТЫ
        for tool in avdmanager profgen; do
          TOOL_SOURCE="$SDK_BASE/cmdline-tools/latest/bin/$tool"
          TOOL_TARGET="$SDK_BASE/tools/bin/$tool"
          if [ -f "$TOOL_SOURCE" ]; then
            sudo ln -sf "$TOOL_SOURCE" "$TOOL_TARGET"
            echo "✅ Ссылка на $tool создана"
          fi
        done
        
        # 3. СОЗДАЕМ ССЫЛКИ НА LIB (КРИТИЧЕСКИ ВАЖНО!)
        echo "Создаем ссылки на библиотеки..."
        
        # Создаем lib директорию в tools
        sudo mkdir -p "$SDK_BASE/tools/lib"
        
        # Копируем ВСЕ JAR файлы из cmdline-tools/lib в tools/lib
        if [ -d "$SDK_BASE/cmdline-tools/latest/lib" ]; then
          echo "Копируем JAR файлы..."
          sudo cp -r "$SDK_BASE/cmdline-tools/latest/lib/"* "$SDK_BASE/tools/lib/" 2>/dev/null || true
          
          # Создаем символические ссылки на ключевые JAR
          for jar in sdkmanager-classpath.jar sdk-common.jar common.jar; do
            JAR_SOURCE="$SDK_BASE/cmdline-tools/latest/lib/$jar"
            JAR_TARGET="$SDK_BASE/tools/lib/$jar"
            if [ -f "$JAR_SOURCE" ]; then
              sudo ln -sf "$JAR_SOURCE" "$JAR_TARGET"
              echo "✅ Ссылка на $jar создана"
            elif [ -f "$SDK_BASE/cmdline-tools/latest/lib/external/$jar" ]; then
              sudo ln -sf "$SDK_BASE/cmdline-tools/latest/lib/external/$jar" "$JAR_TARGET"
              echo "✅ Ссылка на $jar создана (в external)"
            else
              echo "⚠️ $jar не найден"
            fi
          done
        fi
        
        # 4. СОЗДАЕМ ФАЙЛ source.properties (важен для sdkmanager)
        echo "Создаем source.properties..."
        sudo tee "$SDK_BASE/tools/source.properties" << 'EOF'
        Pkg.Desc=Android SDK Tools
        Pkg.Revision=26.1.1
        EOF
        
        echo "✅ Полная структура для Buildozer создана"

    # 6. Установка Java 8
    - name: Setup Java 8
      run: |
        sudo apt update
        sudo apt install -y openjdk-8-jdk
        echo "✅ Java 8 установлена"

    # 7. Системные зависимости
    - name: Install system dependencies
      run: |
        sudo apt update
        sudo apt install -y \
          python3-pip python3-dev git zip unzip build-essential \
          libsdl2-dev libsdl2-image-dev libsdl2-mixer-dev libsdl2-ttf-dev \
          libpango1.0-dev libharfbuzz-dev
        echo "✅ Зависимости установлены"

    # 8. Установка Buildozer и Kivy
    - name: Install Buildozer and Kivy
      run: |
        pip install buildozer cython
        pip install kivy
        echo "✅ Buildozer и Kivy установлены"

    # 9. ПРИНЯТИЕ ЛИЦЕНЗИЙ И УСТАНОВКА КОМПОНЕНТОВ
    - name: Accept licenses and install components
      run: |
        echo "=== Принятие лицензий и установка компонентов ==="
        
        # ДВА ВАРИАНТА SDKMANAGER
        SDKMANAGER1="/usr/local/lib/android/sdk/tools/bin/sdkmanager"
        SDKMANAGER2="/usr/local/lib/android/sdk/cmdline-tools/latest/bin/sdkmanager"
        
        # Выбираем рабочий sdkmanager
        SDKMANAGER=""
        if [ -f "$SDKMANAGER1" ] && [ -x "$SDKMANAGER1" ]; then
          SDKMANAGER="$SDKMANAGER1"
          echo "✅ Используем sdkmanager из tools/bin"
        elif [ -f "$SDKMANAGER2" ] && [ -x "$SDKMANAGER2" ]; then
          SDKMANAGER="$SDKMANAGER2"
          echo "✅ Используем sdkmanager из cmdline-tools"
        else
          echo "❌ sdkmanager не найден!"
          exit 1
        fi
        
        # ПРИНИМАЕМ ЛИЦЕНЗИИ (надежный способ)
        echo "Принимаем лицензии..."
        mkdir -p ~/.android
        
        # Создаем файл лицензий
        cat > ~/.android/repositories.cfg << 'EOF'
        count=3
        8933bad161af4178b1185d1a37fbf41ea5269c55
        d56f5187479451eabf01fb78af6dfcb131a6481e
        24333f8a63b6825ea9c5514f83c2829b004d1fee
        EOF
        
        # Пробуем принять лицензии через echo
        { echo "y"; echo "y"; echo "y"; echo "y"; sleep 1; } | $SDKMANAGER --licenses > /dev/null 2>&1 || true
        
        # УСТАНАВЛИВАЕМ КОМПОНЕНТЫ
        echo "Устанавливаем platform-tools..."
        $SDKMANAGER "platform-tools" || echo "⚠️ Не удалось установить platform-tools"
        
        echo "Устанавливаем build-tools..."
        $SDKMANAGER "build-tools;30.0.3" || echo "⚠️ Пробуем другую версию"
        
        echo "Устанавливаем platform..."
        $SDKMANAGER "platforms;android-30" || echo "⚠️ Пробуем android-31"
        
        echo "Устанавливаем NDK..."
        $SDKMANAGER "ndk;21.3.6528147" || $SDKMANAGER "ndk;23.1.7779620" || echo "⚠️ Не удалось установить NDK"
        
        echo "✅ Компоненты установлены"

    # 10. НАХОДИМ NDK И НАСТРАИВАЕМ ПУТИ
    - name: Find NDK and setup paths
      run: |
        echo "=== Поиск NDK ==="
        
        # Ищем NDK
        NDK_PATH=""
        POSSIBLE_PATHS=(
          "/usr/local/lib/android/sdk/ndk/21.3.6528147"
          "/usr/local/lib/android/sdk/ndk/23.1.7779620"
          "/usr/local/lib/android/sdk/ndk-bundle"
        )
        
        for path in "${POSSIBLE_PATHS[@]}"; do
          if [ -d "$path" ]; then
            NDK_PATH="$path"
            echo "✅ NDK найден: $NDK_PATH"
            break
          fi
        done
        
        if [ -z "$NDK_PATH" ]; then
          # Ищем любую NDK
          NDK_PATH=$(find /usr/local/lib/android/sdk -name "*ndk*" -type d | head -1)
          if [ -n "$NDK_PATH" ]; then
            echo "✅ NDK найден (первый попавшийся): $NDK_PATH"
          else
            echo "⚠️ NDK не найден, создаем заглушку"
            NDK_PATH="/usr/local/lib/android/sdk/ndk/default"
            sudo mkdir -p "$NDK_PATH"
          fi
        fi
        
        echo "NDK_PATH=$NDK_PATH" >> $GITHUB_ENV
        echo "ANDROID_SDK_ROOT=/usr/local/lib/android/sdk" >> $GITHUB_ENV
        echo "ANDROID_HOME=/usr/local/lib/android/sdk" >> $GITHUB_ENV

    # 11. ПОДГОТОВКА ПРИЛОЖЕНИЯ
    - name: Prepare application
      run: |
        echo "=== Подготовка приложения ==="
        
        # main.py
        echo "from kivy.app import App" > main.py
        echo "from kivy.uix.label import Label" >> main.py
        echo "" >> main.py
        echo "class TestApp(App):" >> main.py
        echo "    def build(self):" >> main.py
        echo "        return Label(text='Test APK')" >> main.py
        echo "" >> main.py
        echo "if __name__ == '__main__':" >> main.py
        echo "    TestApp().run()" >> main.py
        
        # buildozer.spec
        cat > buildozer.spec << EOF
        [app]
        title = TestApp
        package.name = testapp
        source.dir = .
        requirements = python3,kivy
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a
        android.sdk_path = /usr/local/lib/android/sdk
        android.ndk_path = $NDK_PATH

        [buildozer]
        log_level = 1
        android.accept_sdk_license = True
        EOF
        
        echo "✅ Приложение подготовлено"

    # 12. СБОРКА APK
    - name: Build APK
      run: |
        echo "=== Сборка APK ==="
        
        export ANDROID_SDK_ROOT="/usr/local/lib/android/sdk"
        export ANDROID_HOME="/usr/local/lib/android/sdk"
        
        echo "Начинаем сборку..."
        buildozer android debug
        
        echo "✅ Сборка завершена"
        
        if [ -d "bin" ]; then
          echo "APK файлы:"
          ls -la bin/*.apk 2>/dev/null || echo "APK не созданы"
        fi

    # 13. ЗАГРУЗКА APK
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: apk
        path: bin/*.apk
        if-no-files-found: warn

    # 14. ОТЛАДКА
    - name: Debug on failure
      if: failure()
      run: |
        echo "=== ОТЛАДКА ==="
        echo ""
        echo "1. SDK структура:"
        find /usr/local/lib/android/sdk -type f -name "*.jar" | head -20
        echo ""
        echo "2. sdkmanager:"
        ls -la /usr/local/lib/android/sdk/tools/bin/sdkmanager 2>/dev/null || echo "Не найден"
        echo ""
        echo "3. Java:"
        java -version
        echo ""
        echo "4. Buildozer log:"
        tail -100 .buildozer/android/platform/build.log 2>/dev/null || echo "Лог не найден"