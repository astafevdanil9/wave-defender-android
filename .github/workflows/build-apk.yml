name: Build Wave Defender APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup environment
      run: |
        sudo apt update
        sudo apt install -y python3-pip python3-venv python3-dev
        
        # Используем Python 3.10 который уже есть в Ubuntu 22.04
        python3 -m venv venv
        source venv/bin/activate
        
        pip install --upgrade pip setuptools wheel
        pip install buildozer cython==0.29.33 pygame==2.5.0
    
    - name: Create buildozer.spec (фикс через p4a)
      run: |
        source venv/bin/activate
        
          cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = com.astafevdanil9
        source.dir = .
        source.main = main.py
        version = 1.0
        requirements = python3, pygame==2.5.0, sdl2_ttf
        orientation = landscape
        fullscreen = 1
        android.archs = arm64-v8a  # Меняем на arm64-v8a
        android.permissions = INTERNET, VIBRATE
        android.api = 30
        android.minapi = 21

        [buildozer]
        warn_on_root = 0
        log_level = 2
        android.accept_sdk_license = True

        # КРИТИЧЕСКИ ВАЖНО: используем develop ветку p4a
        p4a.branch = develop
        p4a.commit = 2024.01.29  # Специфичный коммит для pygame

        # Фикс для сборки pygame
        android.add_src = {
            "pygame": {
                "recipe": "pygame",
                "version": "2.5.0"
            }
        }
        EOF
        
        echo "✅ buildozer.spec создан с фиксами для pygame"
    
    - name: Accept licenses via sdkmanager
      run: |
        # Создаем директории Android SDK если нет
        mkdir -p ~/android-sdk/cmdline-tools/latest
        
        # Скачиваем Command Line Tools
        cd ~/android-sdk
        wget -q https://dl.google.com/android/repository/commandlinetools-linux-9477386_latest.zip
        unzip -q commandlinetools-linux-9477386_latest.zip
        mv cmdline-tools latest
        mv latest cmdline-tools/
        rm commandlinetools-linux-9477386_latest.zip
        
        # Принимаем ВСЕ лицензии автоматически
        yes | ~/android-sdk/cmdline-tools/latest/bin/sdkmanager --licenses 2>/dev/null || true
        
        echo "✅ Все лицензии приняты через sdkmanager"
    
    - name: Build APK
      run: |
        source venv/bin/activate
        
        sudo fallocate -l 2G /swapfile
        sudo chmod 600 /swapfile
        sudo mkswap /swapfile
        sudo swapon /swapfile
        
        buildozer android debug
        
        sudo swapoff /swapfile
        sudo rm /swapfile
    
    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: wave-defender
        path: bin/*.apk