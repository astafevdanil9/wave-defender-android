name: Build Android APK

on:
  push:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ubuntu-22.04
    
    steps:
    - uses: actions/checkout@v4

    - name: Set up environment and modern Android CLI tools
      run: |
        sudo apt update
        sudo apt install -y \
          python3 \
          python3-pip \
          python3-venv \
          git \
          zip \
          unzip \
          openjdk-11-jdk \
          autoconf \
          automake \
          libtool \
          pkg-config \
          zlib1g-dev \
          libncurses5-dev \
          libncursesw5-dev \
          libtinfo5 \
          cmake \
          libffi-dev \
          libssl-dev
          
        pip3 install --upgrade pip wheel setuptools
        pip3 install buildozer cython pygame==2.1.2
        
        # ГАРАНТИРУЕМ, что используем современные CLI Tools, а не старые 'tools/'
        export ANDROID_SDK_ROOT=/usr/local/lib/android/sdk
        export ANDROID_HOME=$ANDROID_SDK_ROOT
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$ANDROID_SDK_ROOT/platform-tools:$PATH
        
        # Принимаем лицензии с использованием корректного пути
        yes | $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager --licenses
        
        # Устанавливаем необходимые платформы и инструменты через корректную команду
        $ANDROID_SDK_ROOT/cmdline-tools/latest/bin/sdkmanager \
          "platforms;android-30" \
          "build-tools;30.0.3" \
          "platform-tools"
            
    - name: Configure Buildozer
      run: |
        cat > buildozer.spec << 'EOF'
        [app]
        title = Wave Defender
        package.name = wavedefender
        package.domain = org.test
        source.dir = .
        source.include_exts = py,png,jpg,kv,atlas
        version = 1.0
        requirements = python3, pygame==2.1.2
        android.api = 30
        android.minapi = 21
        android.archs = armeabi-v7a
        # КРИТИЧЕСКИ ВАЖНО: указываем путь к SDK без подпапки tools/
        android.sdk_path = /usr/local/lib/android/sdk
        android.ndk_path = /usr/local/lib/android/sdk/ndk/27.3.13750724
        android.accept_sdk_license = true  # Управляем через yes | sdkmanager выше

        [buildozer]
        log_level = 2
        warn_on_root = 0
        EOF

    - name: Build APK
      env:
        # Явно задаем переменные для всего шага
        ANDROID_HOME: /usr/local/lib/android/sdk
        ANDROID_SDK_ROOT: /usr/local/lib/android/sdk
        ANDROID_NDK_HOME: /usr/local/lib/android/sdk/ndk/27.3.13750724
        JAVA_HOME: /usr/lib/jvm/temurin-11-jdk-amd64
      run: |
        # Экспортируем PATH с корректными инструментами
        export PATH=$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools:$PATH
        
        echo "=== Проверка путей ==="
        which sdkmanager
        java -version
        
        echo "=== Сборка APK (это займет время) ==="
        # Запускаем сборку. Используем timeout на случай зависания.
        timeout 1800 buildozer android debug 2>&1 | tail -200

    - name: Check for APK
      run: |
        if ls bin/*.apk 1> /dev/null 2>&1; then
          echo "✅ APK найден!"
          ls -lah bin/
        else
          echo "❌ APK не найден. Возможные причины:"
          echo "1. Недостаточно времени на сборку (таймаут)"
          echo "2. Ошибка в зависимостях Python"
          echo "3. Проблемы с NDK"
        fi

    - uses: actions/upload-artifact@v4
      if: success()
      with:
        name: apk-result
        path: bin/*.apk